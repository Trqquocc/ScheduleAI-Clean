<!-- frontend/components/calendar-sidebar.html - FINAL UPDATED VERSION -->
<div
  class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col h-full"
  id="calendar-sidebar"
>
  <div class="p-4 border-b border-gray-200">
    <h3
      class="font-semibold text-lg text-gray-800 flex items-center justify-between"
    >
      C√¥ng vi·ªác c·ªßa t√¥i
      <button
        id="refresh-tasks-btn"
        class="text-blue-600 hover:text-blue-800 text-sm hover:rotate-180 transition-transform duration-300"
      >
        <i class="fas fa-sync-alt"></i>
      </button>
    </h3>
    <p class="text-xs text-gray-500 mt-1">K√©o th·∫£ v√†o l·ªãch ƒë·ªÉ l√™n k·∫ø ho·∫°ch</p>
  </div>

  <div class="flex-1 overflow-y-auto p-4" id="task-list">
    <div class="text-center text-gray-500 py-8" id="empty-tasks">
      <div class="animate-pulse">ƒêang t·∫£i c√¥ng vi·ªác...</div>
    </div>
  </div>
</div>

<script>
  (function () {
    console.log("üìã Calendar sidebar loaded");

    // ============================
    //   LOAD USER TASKS
    // ============================
    window.loadUserTasks = async function () {
      const token = localStorage.getItem("auth_token");

      if (!token) {
        document.getElementById("task-list").innerHTML = `
        <div class="text-red-600 text-center py-4">
          <i class="fas fa-exclamation-circle text-xl mb-2"></i><br/>
          Vui l√≤ng ƒëƒÉng nh·∫≠p
        </div>`;
        return;
      }

      try {
        // Ch·ªù Utils load xong
        if (typeof Utils === "undefined") {
          console.warn("‚è≥ Utils ch∆∞a load, ƒë·ª£i th√™m...");
          setTimeout(window.loadUserTasks, 200);
          return;
        }

        const payload = JSON.parse(atob(token.split(".")[1]));
        const userId = payload.userId;

        console.log(`üì• Fetching tasks for user ${userId}...`);

        const result = await Utils.makeRequest(
          `/api/tasks?userId=${userId}&status=pending`,
          "GET"
        );

        if (!result.success) throw new Error(result.message);

        const tasks = result.data || [];

        const container = document.getElementById("task-list");
        container.innerHTML = "";

        // Kh√¥ng c√≥ tasks
        if (tasks.length === 0) {
          container.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i class="fas fa-inbox text-4xl mb-2 text-gray-300"></i>
            <p>Kh√¥ng c√≥ c√¥ng vi·ªác n√†o</p>
            <p class="text-xs mt-2">T·∫°o c√¥ng vi·ªác m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
          </div>`;
          return;
        }

        // ============================
        //   RENDER TASK ITEMS
        // ============================
        tasks.forEach((task) => {
          const color = task.MauSac || "#3B82F6";

          const item = document.createElement("div");
          item.className =
            "mb-3 p-3 rounded-lg bg-white shadow-sm border border-gray-200 cursor-move hover:shadow-md transition-all hover:scale-105";
          item.style.borderLeft = `4px solid ${color}`;
          item.draggable = true;

          // ---------- Quan tr·ªçng cho FullCalendar ----------
          item.dataset.taskId = task.MaCongViec || task.ID;
          item.dataset.taskTitle = task.TieuDe;
          item.dataset.taskDescription = task.MoTa || "";
          item.dataset.taskColor = color;
          // ---------------------------------------------------

          item.innerHTML = `
          <div class="flex items-start gap-3">
            <i class="fas fa-grip-vertical text-gray-400 mt-1"></i>
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-800 truncate">${
                task.TieuDe
              }</div>
              ${
                task.MoTa
                  ? `<div class="text-sm text-gray-600 mt-1 line-clamp-2">${task.MoTa}</div>`
                  : ""
              }
              <div class="flex items-center gap-2 mt-2 text-xs text-gray-500">
                ${
                  task.Tag
                    ? `<span class="px-2 py-0.5 bg-gray-100 rounded">${task.Tag}</span>`
                    : ""
                }
                <span><i class="fas fa-calendar-plus"></i> K√©o v√†o l·ªãch</span>
              </div>
            </div>
          </div>
        `;

          // Drag Events
          item.addEventListener("dragstart", (e) => {
            console.log("üéØ Drag started:", task.TieuDe);
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", ""); // fix firefox

            // JSON ƒë·ªÉ FullCalendar s·ª≠ d·ª•ng
            e.dataTransfer.setData(
              "application/json",
              JSON.stringify({
                taskId: item.dataset.taskId,
                title: item.dataset.taskTitle,
                description: item.dataset.taskDescription,
                color: item.dataset.taskColor,
              })
            );

            item.classList.add("opacity-50", "scale-95");
          });

          item.addEventListener("dragend", () => {
            item.classList.remove("opacity-50", "scale-95");
          });

          container.appendChild(item);
        });

        console.log("‚úÖ Task list rendered");
      } catch (err) {
        console.error("‚ùå L·ªói t·∫£i c√¥ng vi·ªác:", err);

        document.getElementById("task-list").innerHTML = `
        <div class="text-red-600 text-center py-4">
          <i class="fas fa-exclamation-triangle mb-2"></i>
          <p>L·ªói t·∫£i d·ªØ li·ªáu</p>
          <button onclick="window.loadUserTasks()" class="mt-2 px-3 py-1 bg-red-100 hover:bg-red-200 rounded text-sm">
            Th·ª≠ l·∫°i
          </button>
        </div>`;
      }
    };

    // Auto load
    if (document.getElementById("task-list")) {
      console.log("üìã Starting task load...");
      setTimeout(window.loadUserTasks, 300);
    }

    // Refresh button
    const refreshBtn = document.getElementById("refresh-tasks-btn");
    if (refreshBtn) {
      refreshBtn.addEventListener("click", () => {
        refreshBtn.classList.add("animate-spin");
        window.loadUserTasks().finally(() => {
          setTimeout(() => refreshBtn.classList.remove("animate-spin"), 300);
        });
      });
    }
  })();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
