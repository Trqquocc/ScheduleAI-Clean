<!-- components/modals/create-task-modal.html -->

<!-- Overlay -->
<div class="modal-overlay" data-modal-close></div>

<!-- Modal Content -->
<div
  class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
  id="createTaskModalContent"
>
  <!-- Modal Header -->
  <div
    class="sticky top-0 z-10 bg-white border-b px-6 py-4 flex justify-between items-center"
  >
    <h2 class="text-xl font-bold text-gray-800">T·∫°o c√¥ng vi·ªác m·ªõi</h2>
    <button
      id="closeCreateTaskBtn"
      class="text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Close"
    >
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>

  <!-- Modal Body -->
  <div class="p-6">
    <form id="createTaskForm" class="space-y-6">
      <!-- Ti√™u ƒë·ªÅ -->
      <div>
        <label
          for="taskTitle"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Ti√™u ƒë·ªÅ c√¥ng vi·ªác *
        </label>
        <input
          type="text"
          id="taskTitle"
          name="taskTitle"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác..."
        />
      </div>

      <!-- M√¥ t·∫£ -->
      <div>
        <label
          for="taskDescription"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M√¥ t·∫£ (t√πy ch·ªçn)
        </label>
        <textarea
          id="taskDescription"
          name="taskDescription"
          rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt..."
        ></textarea>
      </div>

      <!-- Danh m·ª•c -->
      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="block text-sm font-medium text-gray-700">
            Danh m·ª•c
          </label>
          <button
            type="button"
            id="createNewCategoryBtn"
            class="text-xs text-blue-600 hover:text-blue-800 transition-colors"
          >
            <i class="fas fa-plus mr-1"></i> T·∫°o m·ªõi danh m·ª•c
          </button>
        </div>
        <div
          id="category-container"
          class="border border-gray-300 rounded-md p-3 min-h-[60px] max-h-[200px] overflow-y-auto bg-gray-50"
        >
          <!-- Danh m·ª•c s·∫Ω load ƒë·ªông ·ªü ƒë√¢y -->
          <div class="text-gray-500 text-center py-4" id="category-loading">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            ƒêang t·∫£i danh m·ª•c...
          </div>
        </div>
      </div>

      <!-- Tag -->
      <div>
        <label
          for="taskTag"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Tag
        </label>
        <input
          type="text"
          id="taskTag"
          name="taskTag"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="urgent, project, important..."
        />
      </div>

      <!-- Th·ªùi gian ∆∞·ªõc t√≠nh (chung) -->
      <div>
        <label
          for="taskDuration"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Th·ªùi gian ∆∞·ªõc t√≠nh (ph√∫t)
        </label>
        <input
          type="number"
          id="taskDuration"
          name="taskDuration"
          value="60"
          min="5"
          step="5"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- M·ª©c ƒë·ªô ∆∞u ti√™n -->
      <div>
        <label
          for="taskPriority"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô ∆∞u ti√™n
        </label>
        <select
          id="taskPriority"
          name="taskPriority"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="1">Th·∫•p</option>
          <option value="2" selected>Trung b√¨nh</option>
          <option value="3">Cao</option>
          <option value="4">R·∫•t cao</option>
        </select>
      </div>

      <!-- M·ª©c ƒë·ªô ph·ª©c t·∫°p -->
      <div>
        <label
          for="taskComplexity"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô ph·ª©c t·∫°p
        </label>
        <select
          id="taskComplexity"
          name="taskComplexity"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
          <option value="1">ƒê∆°n gi·∫£n</option>
          <option value="2">Trung b√¨nh</option>
          <option value="3">Ph·ª©c t·∫°p</option>
          <option value="4">R·∫•t ph·ª©c t·∫°p</option>
        </select>
      </div>

      <!-- M·ª©c ƒë·ªô t·∫≠p trung -->
      <div>
        <label
          for="taskFocusLevel"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô t·∫≠p trung
        </label>
        <select
          id="taskFocusLevel"
          name="taskFocusLevel"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
          <option value="1">Th·∫•p</option>
          <option value="2">Trung b√¨nh</option>
          <option value="3">Cao</option>
          <option value="4">R·∫•t cao</option>
        </select>
      </div>

      <!-- Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p -->
      <div>
        <label
          for="taskSuitableTime"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p
        </label>
        <select
          id="taskSuitableTime"
          name="taskSuitableTime"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn th·ªùi ƒëi·ªÉm</option>
          <option value="1">S√°ng</option>
          <option value="2">Tr∆∞a</option>
          <option value="3">Chi·ªÅu</option>
          <option value="4">T·ªëi</option>
        </select>
      </div>

      <!-- Th·ªùi gian c·ªë ƒë·ªãnh -->
      <div class="border-t pt-4">
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            id="taskFixedTime"
            class="rounded text-blue-600 focus:ring-blue-500"
          />
          <span class="text-sm font-medium text-gray-700"
            >C√≥ th·ªùi gian c·ªë ƒë·ªãnh</span
          >
        </label>

        <!-- Fields th·ªùi gian c·ªë ƒë·ªãnh -->
        <div
          id="fixedTimeFields"
          class="hidden mt-4 space-y-4 bg-gray-50 p-4 rounded-md"
        >
          <div>
            <label
              for="taskFixedStartTime"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Ng√†y v√† gi·ªù b·∫Øt ƒë·∫ßu *
            </label>
            <input
              type="datetime-local"
              id="taskFixedStartTime"
              name="taskFixedStartTime"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="taskFixedDuration"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Th·ªùi l∆∞·ª£ng (ph√∫t)
            </label>
            <input
              type="number"
              id="taskFixedDuration"
              name="taskFixedDuration"
              value="60"
              min="5"
              step="5"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="taskFixedEndTime"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Gi·ªù k·∫øt th√∫c (t·ª± ƒë·ªông)
            </label>
            <input
              type="datetime-local"
              id="taskFixedEndTime"
              name="taskFixedEndTime"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
            />
          </div>

          <!-- T√πy ch·ªçn l·∫∑p l·∫°i -->
          <div>
            <label
              for="taskRepeatOption"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              L·∫∑p l·∫°i
            </label>
            <select
              id="taskRepeatOption"
              name="taskRepeatOption"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Kh√¥ng l·∫∑p</option>
              <option value="daily">H√†ng ng√†y</option>
              <option value="weekly">H√†ng tu·∫ßn</option>
              <option value="monthly">H√†ng th√°ng</option>
              <option value="custom">T√πy ch·ªânh</option>
            </select>
          </div>
        </div>
      </div>

      <!-- L∆∞∆°ng theo gi·ªù -->
      <div>
        <label
          for="taskHourlyWage"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          L∆∞∆°ng theo gi·ªù (VND)
        </label>
        <input
          type="number"
          id="taskHourlyWage"
          name="taskHourlyWage"
          value="0"
          min="0"
          step="1000"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-end gap-3 pt-6 border-t">
        <button
          type="button"
          id="cancelCreateTaskBtn"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
        >
          H·ªßy
        </button>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors flex items-center gap-2"
        >
          <span class="submit-text">T·∫°o c√¥ng vi·ªác</span>
          <span class="submit-loading hidden">
            <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    console.log("üõ°Ô∏è Setting up modal auto-open guard...");

    const categoryModal = document.getElementById("createCategoryModal");
    if (!categoryModal) return;

    // ƒê·∫£m b·∫£o modal lu√¥n ·∫©n khi load
    categoryModal.style.display = "none";
    categoryModal.classList.add("hidden");

    // Log ƒë·ªÉ debug
    setTimeout(() => {
      console.log("üõ°Ô∏è Guard check - Category modal state:");
      console.log("  - Display style:", categoryModal.style.display);
      console.log(
        "  - Computed display:",
        window.getComputedStyle(categoryModal).display
      );
      console.log(
        "  - Has hidden class:",
        categoryModal.classList.contains("hidden")
      );
    }, 500);
  })();
  // ============================================
  // H√ÄM CH√çNH - HO√ÄN CH·ªàNH
  // ============================================

  // 1. H√ÄM LOAD CATEGORIES (B·∫†N ƒêANG THI·∫æU)
  // 1. H√†m format datetime
  function formatDateTime(date) {
    const d = new Date(date);
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hours = String(d.getHours()).padStart(2, "0");
    const minutes = String(d.getMinutes()).padStart(2, "0");
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  // 2. H√†m calculate end time
  function calculateEndTime() {
    const startInput = document.getElementById("taskFixedStartTime");
    const durationInput = document.getElementById("taskFixedDuration");
    const endInput = document.getElementById("taskFixedEndTime");

    if (!startInput?.value || !durationInput?.value) return;

    const start = new Date(startInput.value);
    const duration = parseInt(durationInput.value) || 0;
    const end = new Date(start.getTime() + duration * 60000);

    if (endInput) {
      endInput.value = formatDateTime(end);
    }
  }

  async function loadCategoriesForModal() {
    console.log("üîÑ [CREATE-TASK-MODAL] Loading categories...");

    const container = document.getElementById("category-container");
    if (!container) {
      console.error("‚ùå [CREATE-TASK-MODAL] Category container not found");
      return;
    }

    // Hi·ªÉn th·ªã loading
    container.innerHTML = `
    <div id="category-loading" class="text-gray-500 text-center py-4">
      <i class="fas fa-spinner fa-spin mr-2"></i>
      ƒêang t·∫£i danh m·ª•c...
    </div>
  `;

    try {
      const token = localStorage.getItem("auth_token");
      if (!token) {
        throw new Error("No auth token");
      }

      const response = await fetch("/api/categories", {
        method: "GET",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
        },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      console.log("üì¶ [CREATE-TASK-MODAL] Categories result:", result);

      if (result.success && result.data) {
        renderCategories(result.data);
      } else {
        throw new Error(result.message || "Failed to load categories");
      }
    } catch (error) {
      console.error("‚ùå [CREATE-TASK-MODAL] Error loading categories:", error);
      container.innerHTML = `
      <div class="text-red-500 text-center p-3">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        L·ªói t·∫£i danh m·ª•c: ${error.message}
        <button onclick="loadCategoriesForModal()" class="block mx-auto mt-2 text-blue-500 text-sm hover:underline">
          <i class="fas fa-redo mr-1"></i> Th·ª≠ l·∫°i
        </button>
      </div>
    `;
    }
  }

  function renderCategories(categories) {
    const container = document.getElementById("category-container");
    if (!container) return;

    // X√ìA loading state
    const loadingEl = document.getElementById("category-loading");
    if (loadingEl) loadingEl.remove();

    if (!categories || categories.length === 0) {
      container.innerHTML = `
      <div class="text-gray-500 text-center py-4 italic">
        Ch∆∞a c√≥ danh m·ª•c n√†o.
        <br>
        Nh·∫•n "+ T·∫°o m·ªõi danh m·ª•c" ƒë·ªÉ th√™m.
      </div>
    `;
      return;
    }

    let html = "";
    categories.forEach((cat, index) => {
      html += `
      <div class="flex items-center border border-gray-300 rounded px-3 py-2 mb-2 hover:bg-gray-50 transition-colors">
        <label class="flex items-center gap-3 cursor-pointer flex-1">
          <input 
            type="radio" 
            name="taskCategory" 
            value="${cat.MaLoai}" 
            class="category-radio h-4 w-4 text-blue-600 focus:ring-blue-500" 
            ${index === 0 ? "checked" : ""}
          />
          <span class="text-sm font-medium text-gray-700">${cat.TenLoai}</span>
        </label>
      </div>
    `;
    });

    container.innerHTML = html;
    console.log(
      `‚úÖ [CREATE-TASK-MODAL] Rendered ${categories.length} categories`
    );
  }

  // 2. H√ÄM X·ª¨ L√ù TAG
  function getTagsFromInput() {
    const tagInput = document.getElementById("taskTag");
    if (!tagInput) return [];

    const tagValue = tagInput.value.trim();
    if (!tagValue) return [];

    return tagValue
      .split(",")
      .map((tag) => tag.trim())
      .filter((tag) => tag.length > 0);
  }

  function getSelectedCategoryId() {
    const selectedRadio = document.querySelector(
      'input[name="taskCategory"]:checked'
    );
    return selectedRadio ? selectedRadio.value : null;
  }

  // 3. H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO
  function showNotification(message, type = "info") {
    // Ki·ªÉm tra xem ƒë√£ c√≥ Utils ch∆∞a
    if (window.Utils && typeof Utils.showToast === "function") {
      Utils.showToast(message, type);
      return;
    }

    // Fallback: T·∫°o toast ƒë∆°n gi·∫£n
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md shadow-lg transition-all duration-300 transform translate-x-0 ${
      type === "success"
        ? "bg-green-500 text-white"
        : type === "error"
        ? "bg-red-500 text-white"
        : "bg-blue-500 text-white"
    }`;
    toast.innerHTML = `
      <div class="flex items-center gap-2">
        <i class="fas ${
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : "fa-info-circle"
        }"></i>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.transform = "translateX(100%)";
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }

  // 4. H√ÄM X·ª¨ L√ù FORM T·∫†O TASK
  async function handleCreateTaskForm() {
    const form = document.getElementById("createTaskForm");
    if (!form) return;

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      e.stopPropagation();

      console.log("üìù [CREATE-TASK-MODAL] Submitting task form...");

      // Hi·ªÉn th·ªã loading
      const submitBtn = form.querySelector("button[type='submit']");
      const submitText = submitBtn.querySelector(".submit-text");
      const submitLoading = submitBtn.querySelector(".submit-loading");

      if (submitText && submitLoading) {
        submitText.classList.add("hidden");
        submitLoading.classList.remove("hidden");
        submitBtn.disabled = true;
      }

      try {
        // L·∫•y d·ªØ li·ªáu t·ª´ form
        const formData = {
          TieuDe: document.getElementById("taskTitle").value.trim(),
          MoTa: document.getElementById("taskDescription").value.trim(),
          ThoiGianUocTinh:
            parseInt(document.getElementById("taskDuration").value) || 60,
          MucDoUuTien:
            parseInt(document.getElementById("taskPriority").value) || 2,
          MucDoPhucTap: document.getElementById("taskComplexity").value
            ? parseInt(document.getElementById("taskComplexity").value)
            : null,
          MucDoTapTrung: document.getElementById("taskFocusLevel").value
            ? parseInt(document.getElementById("taskFocusLevel").value)
            : null,
          ThoiDiemThichHop: (() => {
            const value = document.getElementById("taskSuitableTime").value;
            return value && value.trim() !== "" ? value : null;
          })(),
          LuongTheoGio:
            parseInt(document.getElementById("taskHourlyWage").value) || 0,
          CoThoiGianCoDinh: document.getElementById("taskFixedTime").checked,
          tags: getTagsFromInput(),
          MaLoai: getSelectedCategoryId(),
        };

        // Validate d·ªØ li·ªáu
        if (!formData.TieuDe) {
          showNotification("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác", "error");
          throw new Error("Title is required");
        }

        // X·ª≠ l√Ω th·ªùi gian c·ªë ƒë·ªãnh
        if (formData.CoThoiGianCoDinh) {
          const startTime = document.getElementById("taskFixedStartTime").value;
          if (!startTime) {
            showNotification(
              "Vui l√≤ng ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu cho c√¥ng vi·ªác c·ªë ƒë·ªãnh",
              "error"
            );
            throw new Error("Missing start time");
          }

          formData.GioBatDauCoDinh = startTime;
          formData.ThoiLuongCoDinh =
            parseInt(document.getElementById("taskFixedDuration").value) || 60;

          // T√≠nh th·ªùi gian k·∫øt th√∫c
          const start = new Date(startTime);
          const end = new Date(
            start.getTime() + formData.ThoiLuongCoDinh * 60000
          );
          formData.GioKetThucCoDinh = end.toISOString().slice(0, 16);

          const repeatOption =
            document.getElementById("taskRepeatOption").value;
          if (repeatOption) {
            formData.LapLai = repeatOption;
          }
        }

        console.log("üì§ [CREATE-TASK-MODAL] Sending task data:", formData);

        // G·ª≠i request t·∫°o task
        const token = localStorage.getItem("auth_token");
        if (!token) {
          showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i", "error");
          throw new Error("No auth token");
        }

        const response = await fetch("/api/tasks", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(formData),
        });

        const result = await response.json();
        console.log("üì• [CREATE-TASK-MODAL] Create task response:", result);

        if (result.success) {
          showNotification("T·∫°o c√¥ng vi·ªác th√†nh c√¥ng!", "success");
          triggerModalSidebarRefresh();
          // ƒê√≥ng modal
          closeMainModal();

          // Reset form
          form.reset();
          document.getElementById("taskFixedTime").checked = false;
          document.getElementById("fixedTimeFields").classList.add("hidden");

          // G·ªçi h√†m reload tasks n·∫øu c√≥
          if (
            typeof window.WorkManager === "object" &&
            window.WorkManager.reload
          ) {
            window.WorkManager.reload();
          } else if (typeof window.loadTasks === "function") {
            window.loadTasks();
          }

          // Dispatch event
          window.dispatchEvent(
            new CustomEvent("taskCreated", {
              detail: { task: result.data },
            })
          );
        } else {
          showNotification(result.message || "L·ªói khi t·∫°o c√¥ng vi·ªác", "error");
        }
      } catch (error) {
        console.error("‚ùå [CREATE-TASK-MODAL] Error creating task:", error);
        if (
          !error.message.includes("Title is required") &&
          !error.message.includes("Missing start time")
        ) {
          showNotification("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");
        }
      } finally {
        // ·∫®n loading
        if (submitText && submitLoading) {
          submitText.classList.remove("hidden");
          submitLoading.classList.add("hidden");
          submitBtn.disabled = false;
        }
      }
    });
  }

  // 5. H√ÄM X·ª¨ L√ù TH·ªúI GIAN C·ªê ƒê·ªäNH
  function handleFixedTimeToggle() {
    const fixedTimeCheckbox = document.getElementById("taskFixedTime");
    const fixedTimeFields = document.getElementById("fixedTimeFields");
    const startTimeInput = document.getElementById("taskFixedStartTime");
    const durationInput = document.getElementById("taskFixedDuration");
    const createCategoryBtn = document.getElementById("createNewCategoryBtn");
    const categoryModal = document.getElementById("createCategoryModal");
    const categoryOverlay = document.getElementById("categoryModalOverlay");

    if (fixedTimeCheckbox) {
      fixedTimeCheckbox.addEventListener("change", function () {
        if (fixedTimeFields) {
          fixedTimeFields.classList.toggle("hidden", !this.checked);
        }
      });
    }

    if (startTimeInput) {
      startTimeInput.addEventListener("change", calculateEndTime);
    }

    if (durationInput) {
      durationInput.addEventListener("input", calculateEndTime);
    }
    if (!createCategoryBtn || !categoryModal) return;

    // M·ªü modal t·∫°o category
    // Thay th·∫ø ph·∫ßn x·ª≠ l√Ω modal category:

    // M·ªü modal category
    createCategoryBtn.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();

      if (window.ModalManager) {
        ModalManager.showModalById("createCategoryModal");
      } else {
        // Fallback n·∫øu kh√¥ng c√≥ ModalManager
        const categoryModal = document.getElementById("createCategoryModal");
        if (categoryModal) {
          categoryModal.style.display = "flex";
        }
      }
    });

    // ƒê√≥ng modal category
    const closeModal = () => {
      categoryModal.classList.add("hidden");

      // Kh√¥i ph·ª•c modal t·∫°o c√¥ng vi·ªác
      const mainModal = document.getElementById("createTaskModalContent");
      const mainOverlay = document.querySelector(
        ".modal-overlay[data-modal-close]"
      );

      if (mainModal) mainModal.style.opacity = "1";
      if (mainOverlay) mainOverlay.style.backgroundColor = "rgba(0,0,0,0.5)";

      // Reset form
      const categoryForm = document.getElementById("createCategoryForm");
      if (categoryForm) categoryForm.reset();

      const colorInput = document.getElementById("newCategoryColor");
      if (colorInput) colorInput.value = "#3B82F6";
    };

    // X·ª≠ l√Ω ƒë√≥ng b·∫±ng n√∫t X
    const closeCategoryBtn = document.getElementById("closeCategoryModalBtn");
    const cancelCategoryBtn = document.getElementById("cancelCategoryBtn");

    if (closeCategoryBtn)
      closeCategoryBtn.addEventListener("click", closeModal);
    if (cancelCategoryBtn)
      cancelCategoryBtn.addEventListener("click", closeModal);

    // X·ª≠ l√Ω ƒë√≥ng b·∫±ng click overlay
    if (categoryOverlay) {
      categoryOverlay.addEventListener("click", closeModal);
    }
    // X·ª≠ l√Ω click ra ngo√†i
    categoryModal.addEventListener("click", function (e) {
      if (e.target === this) closeModal();
    });

    // X·ª≠ l√Ω form category
    // Submit form
    if (categoryForm) {
      categoryForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        const nameInput = document.getElementById("newCategoryName");
        const descInput = document.getElementById("newCategoryDesc");

        if (!nameInput || !nameInput.value.trim()) {
          showNotification("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c", "error");
          return;
        }

        const categoryData = {
          TenLoai: nameInput.value.trim(),
          MoTa: descInput ? descInput.value.trim() : "",
          // ‚ùå B·ªé MauSac - server s·∫Ω t·ª± ƒë·ªông g√°n m√†u theo priority
        };

        console.log("üì§ Submitting category:", categoryData);

        try {
          const token = localStorage.getItem("auth_token");
          if (!token) {
            throw new Error("No authentication token");
          }

          const response = await fetch("/api/categories", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(categoryData),
          });

          const result = await response.json();
          console.log("üì• Category create result:", result);

          if (result.success) {
            showNotification("T·∫°o danh m·ª•c th√†nh c√¥ng!", "success");
            closeModal();

            // Reload categories
            setTimeout(() => {
              loadCategoriesForModal();
            }, 300);
          } else {
            showNotification(result.message || "L·ªói khi t·∫°o danh m·ª•c", "error");
          }
        } catch (error) {
          console.error("‚ùå Error creating category:", error);
          showNotification("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");
        }
      });
    }
  }

  function setupCategoryButton() {
    const createBtn = document.getElementById("createNewCategoryBtn");
    if (!createBtn) return;

    createBtn.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      console.log("üéØ Opening category modal via ModalManager...");

      // S·ª≠ d·ª•ng ModalManager ƒë·ªÉ m·ªü modal
      if (window.ModalManager && ModalManager.showModalById) {
        ModalManager.showModalById("createCategoryModal");
      } else {
        console.error("‚ùå ModalManager not found");
      }
    });
  }
  // 7. H√ÄM ƒê√ìNG MODAL CH√çNH
  function closeMainModal() {
    const modalOverlay = document.querySelector(".modal-overlay");
    const modalContent = document.getElementById("createTaskModalContent");

    if (modalOverlay) modalOverlay.style.display = "none";
    if (modalContent) modalContent.style.display = "none";

    // Reset form
    const form = document.getElementById("createTaskForm");
    if (form) {
      form.reset();
      document.getElementById("taskPriority").value = "2";
      document.getElementById("taskFixedTime").checked = false;
      document.getElementById("fixedTimeFields").classList.add("hidden");
    }
  }

  // 8. H√ÄM KH·ªûI T·∫†O MODAL CH√çNH
  function initCreateTaskModal() {
    console.log("üîß [CREATE-TASK-MODAL] Initializing modal...");

    // Load danh m·ª•c
    loadCategoriesForModal();

    // X·ª≠ l√Ω form t·∫°o task
    handleCreateTaskForm();

    // X·ª≠ l√Ω toggle th·ªùi gian c·ªë ƒë·ªãnh
    handleFixedTimeToggle();

    // X·ª≠ l√Ω n√∫t ƒë√≥ng/h·ªßy
    const closeBtn = document.getElementById("closeCreateTaskBtn");
    const cancelBtn = document.getElementById("cancelCreateTaskBtn");
    const modalOverlay = document.querySelector(
      ".modal-overlay[data-modal-close]"
    );

    if (closeBtn) closeBtn.addEventListener("click", closeMainModal);
    if (cancelBtn) cancelBtn.addEventListener("click", closeMainModal);
    if (modalOverlay) modalOverlay.addEventListener("click", closeMainModal);

    const closeMainModalOriginal = closeMainModal;
    closeMainModal = function () {
      resetFormToCreateMode();
      closeMainModalOriginal();
    };

    // Ho·∫∑c th√™m ri√™ng event listener:
    document.addEventListener("modalClosed", function (e) {
      if (e.detail && e.detail.modalId === "createTaskModal") {
        resetFormToCreateMode();
      }
    });

    // Set default datetime cho th·ªùi gian c·ªë ƒë·ªãnh
    const startTimeInput = document.getElementById("taskFixedStartTime");
    if (startTimeInput) {
      const now = new Date();
      now.setHours(now.getHours() + 1);
      startTimeInput.value = formatDateTime(now);
      calculateEndTime();
    }

    console.log("‚úÖ [CREATE-TASK-MODAL] Modal fully initialized");
  }

  function loadTaskDataIntoForm(taskData) {
    console.log("üìù Loading task data into form:", taskData);

    // ƒê·ªïi ti√™u ƒë·ªÅ modal th√†nh "Ch·ªânh s·ª≠a c√¥ng vi·ªác"
    const modalTitle = document.querySelector("#createTaskModalContent h2");
    if (modalTitle) {
      modalTitle.textContent = "Ch·ªânh s·ª≠a c√¥ng vi·ªác";
    }

    // ƒê·ªïi text n√∫t submit th√†nh "C·∫≠p nh·∫≠t"
    const submitBtn = document.querySelector(
      "#createTaskForm button[type='submit'] .submit-text"
    );
    if (submitBtn) {
      submitBtn.textContent = "C·∫≠p nh·∫≠t";
    }

    // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
    if (taskData.TieuDe) {
      document.getElementById("taskTitle").value = taskData.TieuDe;
    }

    if (taskData.MoTa) {
      document.getElementById("taskDescription").value = taskData.MoTa;
    }

    if (taskData.ThoiGianUocTinh) {
      document.getElementById("taskDuration").value = taskData.ThoiGianUocTinh;
    }

    if (taskData.MucDoUuTien) {
      document.getElementById("taskPriority").value = taskData.MucDoUuTien;
    }

    if (taskData.MucDoPhucTap) {
      document.getElementById("taskComplexity").value = taskData.MucDoPhucTap;
    }

    if (taskData.MucDoTapTrung) {
      document.getElementById("taskFocusLevel").value = taskData.MucDoTapTrung;
    }

    if (taskData.ThoiDiemThichHop) {
      document.getElementById("taskSuitableTime").value =
        taskData.ThoiDiemThichHop;
    }

    if (taskData.LuongTheoGio) {
      document.getElementById("taskHourlyWage").value = taskData.LuongTheoGio;
    }

    if (taskData.Tag) {
      document.getElementById("taskTag").value = taskData.Tag;
    }

    // X·ª≠ l√Ω danh m·ª•c
    if (taskData.MaLoai) {
      setTimeout(() => {
        const categoryRadio = document.querySelector(
          `input[name="taskCategory"][value="${taskData.MaLoai}"]`
        );
        if (categoryRadio) {
          categoryRadio.checked = true;
        }
      }, 500); // ƒê·ª£i categories load xong
    }

    // X·ª≠ l√Ω th·ªùi gian c·ªë ƒë·ªãnh
    if (taskData.CoThoiGianCoDinh) {
      document.getElementById("taskFixedTime").checked = true;
      document.getElementById("fixedTimeFields").classList.remove("hidden");

      if (taskData.GioBatDauCoDinh) {
        const startTime = new Date(taskData.GioBatDauCoDinh);
        document.getElementById("taskFixedStartTime").value =
          formatDateTime(startTime);
      }

      if (taskData.GioKetThucCoDinh) {
        const endTime = new Date(taskData.GioKetThucCoDinh);
        document.getElementById("taskFixedEndTime").value =
          formatDateTime(endTime);
      }

      if (taskData.LapLai) {
        document.getElementById("taskRepeatOption").value = taskData.LapLai;
      }
    }

    // L∆∞u taskId ƒë·ªÉ bi·∫øt ƒëang edit task n√†o
    window.currentEditingTaskId = taskData.MaCongViec || taskData.ID;
    console.log(
      "‚úÖ Task data loaded into form. Editing task ID:",
      window.currentEditingTaskId
    );
  }

  // H√ÄM X·ª¨ L√ù FORM UPDATE (s·ª≠a form submit handler)
  async function handleUpdateTaskForm(taskId, formData) {
    try {
      const token = localStorage.getItem("auth_token");
      if (!token) {
        showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i", "error");
        throw new Error("No auth token");
      }

      const response = await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(formData),
      });

      const result = await response.json();
      console.log("üì• [CREATE-TASK-MODAL] Update task response:", result);

      if (result.success) {
        showNotification("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!", "success");
        triggerModalSidebarRefresh();
        // Hi·ªÉn th·ªã overlay th√†nh c√¥ng
        if (window.WorkManager && window.WorkManager.showSuccessOverlay) {
          window.WorkManager.showSuccessOverlay("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        }

        // ƒê√≥ng modal
        closeMainModal();

        // G·ªçi h√†m reload tasks
        if (window.WorkManager && window.WorkManager.reload) {
          window.WorkManager.reload();
        }

        // Dispatch event
        window.dispatchEvent(
          new CustomEvent("taskUpdated", {
            detail: { taskId: taskId },
          })
        );

        // Reset editing state
        window.currentEditingTaskId = null;
      } else {
        showNotification(
          result.message || "L·ªói khi c·∫≠p nh·∫≠t c√¥ng vi·ªác",
          "error"
        );
      }
    } catch (error) {
      console.error("‚ùå [CREATE-TASK-MODAL] Error updating task:", error);
      showNotification("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");
    }
  }

  // S·ª¨A H√ÄM handleCreateTaskForm ƒë·ªÉ h·ªó tr·ª£ c·∫£ create v√† update
  async function handleCreateTaskForm() {
    const form = document.getElementById("createTaskForm");
    if (!form) return;

    form.addEventListener("submit", async function (e) {
      e.preventDefault();
      e.stopPropagation();

      const isEditing = !!window.currentEditingTaskId;
      console.log(
        `üìù [CREATE-TASK-MODAL] ${isEditing ? "Updating" : "Creating"} task...`
      );

      // Hi·ªÉn th·ªã loading
      const submitBtn = form.querySelector("button[type='submit']");
      const submitText = submitBtn.querySelector(".submit-text");
      const submitLoading = submitBtn.querySelector(".submit-loading");

      if (submitText && submitLoading) {
        submitText.classList.add("hidden");
        submitLoading.classList.remove("hidden");
        submitBtn.disabled = true;
      }

      try {
        // L·∫•y d·ªØ li·ªáu t·ª´ form (gi·ªØ nguy√™n ph·∫ßn n√†y)
        const formData = {
          TieuDe: document.getElementById("taskTitle").value.trim(),
          MoTa: document.getElementById("taskDescription").value.trim(),
          ThoiGianUocTinh:
            parseInt(document.getElementById("taskDuration").value) || 60,
          MucDoUuTien:
            parseInt(document.getElementById("taskPriority").value) || 2,
          MucDoPhucTap: document.getElementById("taskComplexity").value
            ? parseInt(document.getElementById("taskComplexity").value)
            : null,
          MucDoTapTrung: document.getElementById("taskFocusLevel").value
            ? parseInt(document.getElementById("taskFocusLevel").value)
            : null,
          ThoiDiemThichHop: (() => {
            const value = document.getElementById("taskSuitableTime").value;
            return value && value.trim() !== "" ? value : null;
          })(),
          LuongTheoGio:
            parseInt(document.getElementById("taskHourlyWage").value) || 0,
          CoThoiGianCoDinh: document.getElementById("taskFixedTime").checked,
          Tag: getTagsFromInput().join(","),
          MaLoai: getSelectedCategoryId(),
        };

        // Validate d·ªØ li·ªáu
        if (!formData.TieuDe) {
          showNotification("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác", "error");
          throw new Error("Title is required");
        }

        // X·ª≠ l√Ω th·ªùi gian c·ªë ƒë·ªãnh (gi·ªØ nguy√™n)
        if (formData.CoThoiGianCoDinh) {
          const startTime = document.getElementById("taskFixedStartTime").value;
          if (!startTime) {
            showNotification(
              "Vui l√≤ng ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu cho c√¥ng vi·ªác c·ªë ƒë·ªãnh",
              "error"
            );
            throw new Error("Missing start time");
          }

          formData.GioBatDauCoDinh = startTime;
          const duration =
            parseInt(document.getElementById("taskFixedDuration").value) || 60;

          // T√≠nh th·ªùi gian k·∫øt th√∫c
          const start = new Date(startTime);
          const end = new Date(start.getTime() + duration * 60000);
          formData.GioKetThucCoDinh = end.toISOString().slice(0, 16);

          const repeatOption =
            document.getElementById("taskRepeatOption").value;
          if (repeatOption) {
            formData.LapLai = repeatOption;
          }
        }

        console.log(
          `üì§ [CREATE-TASK-MODAL] Sending ${
            isEditing ? "update" : "create"
          } task data:`,
          formData
        );

        // G·ªåI H√ÄM KH√ÅC NHAU CHO CREATE V√Ä UPDATE
        if (isEditing) {
          // G·ªçi h√†m update
          await handleUpdateTaskForm(window.currentEditingTaskId, formData);
        } else {
          // G·ªçi h√†m create (gi·ªØ nguy√™n ph·∫ßn c≈©)
          const token = localStorage.getItem("auth_token");
          if (!token) {
            showNotification("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i", "error");
            throw new Error("No auth token");
          }

          const response = await fetch("/api/tasks", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(formData),
          });

          const result = await response.json();
          console.log("üì• [CREATE-TASK-MODAL] Create task response:", result);

          if (result.success) {
            showNotification("T·∫°o c√¥ng vi·ªác th√†nh c√¥ng!", "success");

            // Hi·ªÉn th·ªã overlay th√†nh c√¥ng
            if (window.WorkManager && window.WorkManager.showSuccessOverlay) {
              window.WorkManager.showSuccessOverlay("T·∫°o m·ªõi th√†nh c√¥ng!");
            }

            // ƒê√≥ng modal
            closeMainModal();

            // Reset form
            form.reset();
            document.getElementById("taskFixedTime").checked = false;
            document.getElementById("fixedTimeFields").classList.add("hidden");

            // G·ªçi h√†m reload tasks
            if (window.WorkManager && window.WorkManager.reload) {
              window.WorkManager.reload();
            }

            // Dispatch event
            window.dispatchEvent(
              new CustomEvent("taskCreated", {
                detail: { task: result.data },
              })
            );
          } else {
            showNotification(
              result.message || "L·ªói khi t·∫°o c√¥ng vi·ªác",
              "error"
            );
          }
        }
      } catch (error) {
        console.error(
          `‚ùå [CREATE-TASK-MODAL] Error ${
            isEditing ? "updating" : "creating"
          } task:`,
          error
        );
        if (
          !error.message.includes("Title is required") &&
          !error.message.includes("Missing start time")
        ) {
          showNotification("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");
        }
      } finally {
        // ·∫®n loading
        if (submitText && submitLoading) {
          submitText.classList.remove("hidden");
          submitLoading.classList.add("hidden");
          submitBtn.disabled = false;
        }
      }
    });
  }

  // H√ÄM RESET FORM V·ªÄ TR·∫†NG TH√ÅI T·∫†O M·ªöI
  function resetFormToCreateMode() {
    const form = document.getElementById("createTaskForm");
    if (form) {
      form.reset();
      document.getElementById("taskFixedTime").checked = false;
      document.getElementById("fixedTimeFields").classList.add("hidden");
      document.getElementById("taskPriority").value = "2";

      // Reset ti√™u ƒë·ªÅ modal
      const modalTitle = document.querySelector("#createTaskModalContent h2");
      if (modalTitle) {
        modalTitle.textContent = "T·∫°o c√¥ng vi·ªác m·ªõi";
      }

      // Reset n√∫t submit
      const submitBtn = document.querySelector(
        "#createTaskForm button[type='submit'] .submit-text"
      );
      if (submitBtn) {
        submitBtn.textContent = "T·∫°o c√¥ng vi·ªác";
      }

      // Reset editing state
      window.currentEditingTaskId = null;
    }
  }

  function triggerModalSidebarRefresh() {
    console.log("üì¢ Modal: Triggering sidebar refresh");

    // Dispatch event
    const event = new CustomEvent("task-changed", {
      detail: {
        action: "refresh",
        source: "createTaskModal",
        timestamp: Date.now(),
      },
    });
    document.dispatchEvent(event);

    // Ho·∫∑c g·ªçi tr·ª±c ti·∫øp
    if (typeof window.triggerSidebarRefresh === "function") {
      setTimeout(() => {
        window.triggerSidebarRefresh();
      }, 300);
    }
  }

  // ============================================
  // XU·∫§T H√ÄM RA GLOBAL
  // ============================================

  window.initCreateTaskModal = initCreateTaskModal;
  window.loadCategoriesForModal = loadCategoriesForModal;
  window.showNotification = showNotification;

  console.log("‚úÖ [CREATE-TASK-MODAL] Script loaded successfully");

  // T·ª± ƒë·ªông kh·ªüi t·∫°o n·∫øu modal ƒë√£ hi·ªÉn th·ªã
  document.addEventListener("DOMContentLoaded", function () {
    const modalContent = document.getElementById("createTaskModalContent");
    if (modalContent && modalContent.style.display !== "none") {
      setTimeout(initCreateTaskModal, 100);
    }
  });

  // L·∫Øng nghe s·ª± ki·ªán modal ƒë∆∞·ª£c m·ªü
  document.addEventListener("modalOpened", function (e) {
    if (e.detail && e.detail.modalId === "createTaskModal") {
      setTimeout(initCreateTaskModal, 50);
    }
  });
  // Kh·ªüi t·∫°o modal khi DOM loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(initCreateTaskModal, 100);
    });
  } else {
    setTimeout(initCreateTaskModal, 100);
  }

  // L·∫Øng nghe event modal opened
  document.addEventListener("modalShown", function (e) {
    if (e.detail && e.detail.modalId === "createTaskModal") {
      console.log("üéØ Modal shown event - initializing");
      setTimeout(initCreateTaskModal, 50);
    }
  });

  // Expose globally
  window.loadCategoriesForModal = loadCategoriesForModal;
  window.initCreateTaskModal = initCreateTaskModal;
</script>

<!-- TH√äM CSS N·∫æU C·∫¶N -->
<style>
  /* Modal Content */
  .modal-content {
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Category Container */
  #category-container {
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
  }

  #category-container::-webkit-scrollbar {
    width: 6px;
  }

  #category-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  #category-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
  }

  #category-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Category Item Hover */
  #category-container .hover\:bg-gray-50:hover {
    background-color: #f9fafb;
    transform: translateX(2px);
    transition: all 0.2s ease;
  }

  /* Category Modal */
  #createCategoryModal {
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10050;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  #createCategoryModal:not(.hidden) {
    display: flex !important;
  }

  #createCategoryModal > div:not(.absolute) {
    z-index: 10051;
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
  }

  #categoryModalOverlay {
    z-index: 10050;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }

  /* Fixed Time Fields */
  #fixedTimeFields {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      max-height: 0;
    }
    to {
      opacity: 1;
      max-height: 500px;
    }
  }

  /* Form Inputs */
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  #success-overlay {
    backdrop-filter: blur(4px);
  }

  #success-overlay > div {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid #e2e8f0;
  }

  #success-overlay .fa-check {
    animation: checkmark 0.5s ease-in-out;
  }

  @keyframes checkmark {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Animation cho overlay */
  #success-overlay {
    animation: fadeIn 0.3s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
