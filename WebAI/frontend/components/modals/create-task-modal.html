<!-- components/modals/create-task-modal.html -->

<!-- Overlay -->
<div class="modal-overlay" data-modal-close></div>

<!-- Modal Content -->
<div
  class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
  id="createTaskModalContent"
>
  <!-- Modal Header -->
  <div
    class="sticky top-0 z-10 bg-white border-b px-6 py-4 flex justify-between items-center"
  >
    <h2 class="text-xl font-bold text-gray-800">T·∫°o c√¥ng vi·ªác m·ªõi</h2>
    <button
      id="closeCreateTaskBtn"
      class="text-gray-400 hover:text-gray-600 transition-colors"
      aria-label="Close"
    >
      <i class="fas fa-times text-xl"></i>
    </button>
  </div>

  <!-- Modal Body -->
  <div class="p-6">
    <form id="createTaskForm" class="space-y-6">
      <!-- Ti√™u ƒë·ªÅ -->
      <div>
        <label
          for="taskTitle"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Ti√™u ƒë·ªÅ c√¥ng vi·ªác *
        </label>
        <input
          type="text"
          id="taskTitle"
          name="taskTitle"
          required
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác..."
        />
      </div>

      <!-- M√¥ t·∫£ -->
      <div>
        <label
          for="taskDescription"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M√¥ t·∫£ (t√πy ch·ªçn)
        </label>
        <textarea
          id="taskDescription"
          name="taskDescription"
          rows="3"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt..."
        ></textarea>
      </div>

      <!-- Danh m·ª•c -->
      <div>
        <div class="flex justify-between items-center mb-1">
          <label class="block text-sm font-medium text-gray-700">
            Danh m·ª•c
          </label>
          <button
            type="button"
            id="createNewCategoryBtn"
            class="text-xs text-blue-600 hover:text-blue-800 transition-colors"
          >
            <i class="fas fa-plus mr-1"></i> T·∫°o m·ªõi danh m·ª•c
          </button>
        </div>
        <div
          id="category-container"
          class="border border-gray-300 rounded-md p-3 min-h-[60px] max-h-[200px] overflow-y-auto bg-gray-50"
        >
          <!-- Danh m·ª•c s·∫Ω load ƒë·ªông ·ªü ƒë√¢y -->
          <div class="text-gray-500 text-center py-4" id="category-loading">
            <i class="fas fa-spinner fa-spin mr-2"></i>
            ƒêang t·∫£i danh m·ª•c...
          </div>
        </div>
      </div>

      <!-- Tag -->
      <div>
        <label
          for="taskTag"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Tag
        </label>
        <input
          type="text"
          id="taskTag"
          name="taskTag"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="urgent, project, important..."
        />
      </div>

      <!-- Th·ªùi gian ∆∞·ªõc t√≠nh (chung) -->
      <div>
        <label
          for="taskDuration"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Th·ªùi gian ∆∞·ªõc t√≠nh (ph√∫t)
        </label>
        <input
          type="number"
          id="taskDuration"
          name="taskDuration"
          value="60"
          min="5"
          step="5"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- M·ª©c ƒë·ªô ∆∞u ti√™n -->
      <div>
        <label
          for="taskPriority"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô ∆∞u ti√™n
        </label>
        <select
          id="taskPriority"
          name="taskPriority"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="1">Th·∫•p</option>
          <option value="2" selected>Trung b√¨nh</option>
          <option value="3">Cao</option>
          <option value="4">R·∫•t cao</option>
        </select>
      </div>

      <!-- M·ª©c ƒë·ªô ph·ª©c t·∫°p -->
      <div>
        <label
          for="taskComplexity"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô ph·ª©c t·∫°p
        </label>
        <select
          id="taskComplexity"
          name="taskComplexity"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
          <option value="1">ƒê∆°n gi·∫£n</option>
          <option value="2">Trung b√¨nh</option>
          <option value="3">Ph·ª©c t·∫°p</option>
          <option value="4">R·∫•t ph·ª©c t·∫°p</option>
        </select>
      </div>

      <!-- M·ª©c ƒë·ªô t·∫≠p trung -->
      <div>
        <label
          for="taskFocusLevel"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          M·ª©c ƒë·ªô t·∫≠p trung
        </label>
        <select
          id="taskFocusLevel"
          name="taskFocusLevel"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
          <option value="1">Th·∫•p</option>
          <option value="2">Trung b√¨nh</option>
          <option value="3">Cao</option>
          <option value="4">R·∫•t cao</option>
        </select>
      </div>

      <!-- Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p -->
      <div>
        <label
          for="taskSuitableTime"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p
        </label>
        <select
          id="taskSuitableTime"
          name="taskSuitableTime"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="">Ch·ªçn th·ªùi ƒëi·ªÉm</option>
          <option value="1">S√°ng</option>
          <option value="2">Tr∆∞a</option>
          <option value="3">Chi·ªÅu</option>
          <option value="4">T·ªëi</option>
        </select>
      </div>

      <!-- Th·ªùi gian c·ªë ƒë·ªãnh -->
      <div class="border-t pt-4">
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            id="taskFixedTime"
            class="rounded text-blue-600 focus:ring-blue-500"
          />
          <span class="text-sm font-medium text-gray-700"
            >C√≥ th·ªùi gian c·ªë ƒë·ªãnh</span
          >
        </label>

        <!-- Fields th·ªùi gian c·ªë ƒë·ªãnh -->
        <div
          id="fixedTimeFields"
          class="hidden mt-4 space-y-4 bg-gray-50 p-4 rounded-md"
        >
          <div>
            <label
              for="taskFixedStartTime"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Ng√†y v√† gi·ªù b·∫Øt ƒë·∫ßu *
            </label>
            <input
              type="datetime-local"
              id="taskFixedStartTime"
              name="taskFixedStartTime"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="taskFixedDuration"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Th·ªùi l∆∞·ª£ng (ph√∫t)
            </label>
            <input
              type="number"
              id="taskFixedDuration"
              name="taskFixedDuration"
              value="60"
              min="5"
              step="5"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>

          <div>
            <label
              for="taskFixedEndTime"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              Gi·ªù k·∫øt th√∫c (t·ª± ƒë·ªông)
            </label>
            <input
              type="datetime-local"
              id="taskFixedEndTime"
              name="taskFixedEndTime"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
            />
          </div>

          <!-- T√πy ch·ªçn l·∫∑p l·∫°i -->
          <div>
            <label
              for="taskRepeatOption"
              class="block text-sm font-medium text-gray-700 mb-1"
            >
              L·∫∑p l·∫°i
            </label>
            <select
              id="taskRepeatOption"
              name="taskRepeatOption"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Kh√¥ng l·∫∑p</option>
              <option value="daily">H√†ng ng√†y</option>
              <option value="weekly">H√†ng tu·∫ßn</option>
              <option value="monthly">H√†ng th√°ng</option>
              <option value="custom">T√πy ch·ªânh</option>
            </select>
          </div>
        </div>
      </div>

      <!-- L∆∞∆°ng theo gi·ªù -->
      <div>
        <label
          for="taskHourlyWage"
          class="block text-sm font-medium text-gray-700 mb-1"
        >
          L∆∞∆°ng theo gi·ªù (VND)
        </label>
        <input
          type="number"
          id="taskHourlyWage"
          name="taskHourlyWage"
          value="0"
          min="0"
          step="1000"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Modal Footer -->
      <div class="flex justify-end gap-3 pt-6 border-t">
        <button
          type="button"
          id="cancelCreateTaskBtn"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
        >
          H·ªßy
        </button>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors flex items-center gap-2"
        >
          <span class="submit-text">T·∫°o c√¥ng vi·ªác</span>
          <span class="submit-loading hidden">
            <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...
          </span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal t·∫°o danh m·ª•c m·ªõi -->
<div
  id="createCategoryModal"
  class="fixed inset-0 flex items-center justify-center hidden"
  style="z-index: 10000 !important; background-color: rgba(0, 0, 0, 0.5)"
>
  <div class="bg-white p-6 rounded-lg w-96">
    <button
      id="closeCategoryModalBtn"
      class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 z-10"
    >
      <i class="fas fa-times text-lg"></i>
    </button>
    <h3 class="text-lg font-semibold mb-4">T·∫°o danh m·ª•c m·ªõi</h3>
    <form id="createCategoryForm">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">T√™n danh m·ª•c *</label>
          <input
            id="newCategoryName"
            type="text"
            class="w-full border rounded px-3 py-2"
            required
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">M√†u s·∫Øc</label>
          <input
            id="newCategoryColor"
            type="color"
            class="w-full border rounded px-3 py-2"
            value="#3B82F6"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">M√¥ t·∫£</label>
          <textarea
            id="newCategoryDesc"
            class="w-full border rounded px-3 py-2"
            rows="2"
          ></textarea>
        </div>
        <div class="flex justify-end gap-2">
          <button
            type="button"
            id="cancelCategoryBtn"
            class="px-4 py-2 border rounded"
          >
            H·ªßy
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded"
          >
            T·∫°o
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ƒê∆†N GI·∫¢N: Script inline ng·∫Øn g·ªçn -->
<script>
  // Debug: Ki·ªÉm tra script c√≥ ch·∫°y kh√¥ng
  console.log("üéØ [CREATE-TASK-MODAL] Script inline started");

  // H√†m load danh m·ª•c
  async function loadCategoriesForModal() {
    console.log("üîÑ [CREATE-TASK-MODAL] loadCategoriesForModal called");

    const container = document.getElementById("category-container");
    if (!container) {
      console.error("‚ùå [CREATE-TASK-MODAL] container not found");
      return;
    }

    container.innerHTML =
      '<div class="text-gray-500 text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i danh m·ª•c...</div>';

    try {
      const token = localStorage.getItem("auth_token");
      if (!token) throw new Error("No auth token");

      console.log("üì§ [CREATE-TASK-MODAL] Fetching categories...");
      const response = await fetch("/api/categories", {
        method: "GET",
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${token}`,
        },
      });

      console.log("üì• [CREATE-TASK-MODAL] Response status:", response.status);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const result = await response.json();
      console.log("üì¶ [CREATE-TASK-MODAL] Result:", result);

      if (result.success && result.data) {
        renderCategories(result.data);
      } else {
        throw new Error(result.message || "Failed to load categories");
      }
    } catch (error) {
      console.error("‚ùå [CREATE-TASK-MODAL] Error:", error);
      const container = document.getElementById("category-container");
      if (container) {
        container.innerHTML = `
        <div class="text-red-500 text-center p-3">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          L·ªói t·∫£i danh m·ª•c: ${error.message}
        </div>
      `;
      }
    }
  }

  function renderCategories(categories) {
    const container = document.getElementById("category-container");
    if (!container) return;

    if (!categories || categories.length === 0) {
      container.innerHTML = `
      <div class="text-gray-500 text-center py-4 italic">
        Ch∆∞a c√≥ danh m·ª•c n√†o.
        <br>
        Nh·∫•n "+ T·∫°o m·ªõi danh m·ª•c" ƒë·ªÉ th√™m.
      </div>
    `;
      return;
    }

    let html = "";
    categories.forEach((cat) => {
      html += `
      <div class="flex items-center justify-between border border-gray-300 rounded px-3 py-2 mb-2 hover:bg-gray-50">
        <label class="flex items-center gap-3 cursor-pointer flex-1">
          <input type="radio" name="taskCategory" value="${cat.MaLoai}" 
                 class="category-radio h-4 w-4 text-blue-600 focus:ring-blue-500" />
          <span class="text-sm font-medium text-gray-700">${cat.TenLoai}</span>
          <div class="w-4 h-4 rounded-full border-2 border-gray-300" 
               style="background-color: ${cat.MauSac || "#3B82F6"}"></div>
        </label>
      </div>
    `;
    });

    container.innerHTML = html;
    console.log(
      `‚úÖ [CREATE-TASK-MODAL] Rendered ${categories.length} categories`
    );
  }

  // Kh·ªüi t·∫°o s·ª± ki·ªán khi modal m·ªü
  function initCreateTaskModal() {
    console.log("üîß [CREATE-TASK-MODAL] initCreateTaskModal called");

    // N√∫t t·∫°o danh m·ª•c
    const createBtn = document.getElementById("createNewCategoryBtn");
    if (createBtn) {
      console.log("‚úÖ [CREATE-TASK-MODAL] Found createNewCategoryBtn");
      createBtn.addEventListener("click", function (e) {
        e.preventDefault();
        e.stopPropagation(); // QUAN TR·ªåNG: NgƒÉn s·ª± ki·ªán lan ra
        e.stopImmediatePropagation(); // NgƒÉn t·∫•t c·∫£ handlers kh√°c

        console.log("‚ûï [CREATE-TASK-MODAL] Create category button clicked");

        const categoryModal = document.getElementById("createCategoryModal");
        if (!categoryModal) {
          console.error("‚ùå Category modal not found!");
          return;
        }

        // FORCE HI·ªÇN TH·ªä
        categoryModal.classList.remove("hidden");
        categoryModal.style.display = "flex";
        categoryModal.style.position = "fixed";
        categoryModal.style.zIndex = "10000"; // CAO H∆†N modal ch√≠nh
        categoryModal.style.backgroundColor = "rgba(0, 0, 0, 0.5)";
        categoryModal.style.opacity = "1";
        categoryModal.style.visibility = "visible";

        // Focus v√†o input
        setTimeout(() => {
          const nameInput = document.getElementById("newCategoryName");
          if (nameInput) nameInput.focus();
        }, 50);

        console.log("‚úÖ Category modal shown with z-index: 10000");
      });
    }

    // Load danh m·ª•c
    loadCategoriesForModal();
  }

  // Xu·∫•t h√†m ƒë·ªÉ g·ªçi t·ª´ b√™n ngo√†i
  window.initCreateTaskModal = initCreateTaskModal;
  window.loadCategoriesForModal = loadCategoriesForModal;

  console.log("‚úÖ [CREATE-TASK-MODAL] Script inline loaded");
</script>
