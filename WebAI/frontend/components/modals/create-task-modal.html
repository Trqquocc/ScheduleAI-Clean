<!-- components/modals/create-task-modal.html -->

<!-- Overlay -->
<div class="modal" id="createTaskModal">
  <!-- Overlay b√™n trong modal container -->
  <div class="modal-overlay" data-modal-close></div>

  <!-- Modal Content b√™n trong modal container -->
  <div
    class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"
    id="createTaskModalContent"
  >
    <!-- Modal Header -->
    <div
      class="sticky top-0 z-10 bg-white border-b px-6 py-4 flex justify-between items-center"
    >
      <h2 class="text-xl font-bold text-gray-800">T·∫°o c√¥ng vi·ªác m·ªõi</h2>
      <button
        id="closeCreateTaskBtn"
        class="text-gray-400 hover:text-gray-600 transition-colors"
        aria-label="Close"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <form id="createTaskForm" class="space-y-6">
        <!-- Ti√™u ƒë·ªÅ -->
        <div>
          <label
            for="taskTitle"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Ti√™u ƒë·ªÅ c√¥ng vi·ªác *
          </label>
          <input
            type="text"
            id="taskTitle"
            name="taskTitle"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác..."
          />
        </div>

        <!-- M√¥ t·∫£ -->
        <div>
          <label
            for="taskDescription"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            M√¥ t·∫£ (t√πy ch·ªçn)
          </label>
          <textarea
            id="taskDescription"
            name="taskDescription"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt..."
          ></textarea>
        </div>

        <!-- Danh m·ª•c -->
        <!-- Danh m·ª•c - S·ª¨A L·∫†I -->
        <!-- Danh m·ª•c - ƒê∆†N GI·∫¢N KH√îNG M√ÄU -->
        <div>
          <div class="flex justify-between items-center mb-2">
            <label class="block text-sm font-medium text-gray-700">
              Danh m·ª•c
            </label>
            <button
              type="button"
              id="createNewCategoryBtn"
              class="text-xs text-blue-600 hover:text-blue-800 transition-colors flex items-center gap-1"
            >
              <i class="fas fa-plus text-xs"></i> T·∫°o m·ªõi
            </button>
          </div>

          <div
            id="category-container"
            class="border border-gray-300 rounded-lg p-3 bg-gray-50 min-h-[60px] max-h-[200px] overflow-y-auto"
          >
            <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
            <div class="text-center py-4 text-gray-500">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              ƒêang t·∫£i danh m·ª•c...
            </div>
          </div>
        </div>

        <!-- Tag -->
        <div>
          <label
            for="taskTag"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Tag
          </label>
          <input
            type="text"
            id="taskTag"
            name="taskTag"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="urgent, project, important..."
          />
        </div>

        <!-- Th·ªùi gian ∆∞·ªõc t√≠nh (chung) -->
        <div>
          <label
            for="taskDuration"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Th·ªùi gian ∆∞·ªõc t√≠nh (ph√∫t)
          </label>
          <input
            type="number"
            id="taskDuration"
            name="taskDuration"
            value="60"
            min="5"
            step="5"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <!-- M·ª©c ƒë·ªô ∆∞u ti√™n -->
        <div>
          <label
            for="taskPriority"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            M·ª©c ƒë·ªô ∆∞u ti√™n
          </label>
          <select
            id="taskPriority"
            name="taskPriority"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="1">Th·∫•p</option>
            <option value="2" selected>Trung b√¨nh</option>
            <option value="3">Cao</option>
            <option value="4">R·∫•t cao</option>
          </select>
        </div>

        <!-- M·ª©c ƒë·ªô ph·ª©c t·∫°p -->
        <div>
          <label
            for="taskComplexity"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            M·ª©c ƒë·ªô ph·ª©c t·∫°p
          </label>
          <select
            id="taskComplexity"
            name="taskComplexity"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
            <option value="1">ƒê∆°n gi·∫£n</option>
            <option value="2">Trung b√¨nh</option>
            <option value="3">Ph·ª©c t·∫°p</option>
            <option value="4">R·∫•t ph·ª©c t·∫°p</option>
          </select>
        </div>

        <!-- M·ª©c ƒë·ªô t·∫≠p trung -->
        <div>
          <label
            for="taskFocusLevel"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            M·ª©c ƒë·ªô t·∫≠p trung
          </label>
          <select
            id="taskFocusLevel"
            name="taskFocusLevel"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Ch·ªçn m·ª©c ƒë·ªô</option>
            <option value="1">Th·∫•p</option>
            <option value="2">Trung b√¨nh</option>
            <option value="3">Cao</option>
            <option value="4">R·∫•t cao</option>
          </select>
        </div>

        <!-- Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p -->
        <div>
          <label
            for="taskSuitableTime"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            Th·ªùi ƒëi·ªÉm th√≠ch h·ª£p
          </label>
          <select
            id="taskSuitableTime"
            name="taskSuitableTime"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Ch·ªçn th·ªùi ƒëi·ªÉm</option>
            <option value="1">S√°ng</option>
            <option value="2">Tr∆∞a</option>
            <option value="3">Chi·ªÅu</option>
            <option value="4">T·ªëi</option>
          </select>
        </div>

        <!-- Th·ªùi gian c·ªë ƒë·ªãnh -->
        <div class="border-t pt-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              id="taskFixedTime"
              class="rounded text-blue-600 focus:ring-blue-500"
            />
            <span class="text-sm font-medium text-gray-700"
              >C√≥ th·ªùi gian c·ªë ƒë·ªãnh</span
            >
          </label>

          <!-- Fields th·ªùi gian c·ªë ƒë·ªãnh -->
          <div
            id="fixedTimeFields"
            class="hidden mt-4 space-y-4 bg-gray-50 p-4 rounded-md"
          >
            <div>
              <label
                for="taskFixedStartTime"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Ng√†y v√† gi·ªù b·∫Øt ƒë·∫ßu *
              </label>
              <input
                type="datetime-local"
                id="taskFixedStartTime"
                name="taskFixedStartTime"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="taskFixedDuration"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Th·ªùi l∆∞·ª£ng (ph√∫t)
              </label>
              <input
                type="number"
                id="taskFixedDuration"
                name="taskFixedDuration"
                value="60"
                min="5"
                step="5"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="taskFixedEndTime"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                Gi·ªù k·∫øt th√∫c (t·ª± ƒë·ªông)
              </label>
              <input
                type="datetime-local"
                id="taskFixedEndTime"
                name="taskFixedEndTime"
                readonly
                class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600"
              />
            </div>

            <!-- T√πy ch·ªçn l·∫∑p l·∫°i -->
            <div>
              <label
                for="taskRepeatOption"
                class="block text-sm font-medium text-gray-700 mb-1"
              >
                L·∫∑p l·∫°i
              </label>
              <select
                id="taskRepeatOption"
                name="taskRepeatOption"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">Kh√¥ng l·∫∑p</option>
                <option value="daily">H√†ng ng√†y</option>
                <option value="weekly">H√†ng tu·∫ßn</option>
                <option value="monthly">H√†ng th√°ng</option>
                <option value="custom">T√πy ch·ªânh</option>
              </select>
            </div>
          </div>
        </div>

        <!-- L∆∞∆°ng theo gi·ªù -->
        <div>
          <label
            for="taskHourlyWage"
            class="block text-sm font-medium text-gray-700 mb-1"
          >
            L∆∞∆°ng theo gi·ªù (VND)
          </label>
          <input
            type="number"
            id="taskHourlyWage"
            name="taskHourlyWage"
            value="0"
            min="0"
            step="1000"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end gap-3 pt-6 border-t">
          <button
            type="button"
            id="cancelCreateTaskBtn"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors"
          >
            H·ªßy
          </button>
          <button
            type="submit"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors flex items-center gap-2"
          >
            <span class="submit-text">T·∫°o c√¥ng vi·ªác</span>
            <span class="submit-loading hidden">
              <i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal t·∫°o danh m·ª•c m·ªõi -->
  <div
    id="createCategoryModal"
    class="fixed inset-0 flex items-center justify-center hidden"
  >
    <div
      class="absolute inset-0 bg-black opacity-50"
      id="categoryModalOverlay"
    ></div>
    <div class="bg-white p-6 rounded-lg w-96">
      <button
        id="closeCategoryModalBtn"
        class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 z-10"
      >
        <i class="fas fa-times text-lg"></i>
      </button>
      <h3 class="text-lg font-semibold mb-4">T·∫°o danh m·ª•c m·ªõi</h3>
      <form id="createCategoryForm">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">T√™n danh m·ª•c *</label>
            <input
              id="newCategoryName"
              type="text"
              class="w-full border rounded px-3 py-2"
              required
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">M√†u s·∫Øc</label>
            <input
              id="newCategoryColor"
              type="color"
              class="w-full border rounded px-3 py-2"
              value="#3B82F6"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">M√¥ t·∫£</label>
            <textarea
              id="newCategoryDesc"
              class="w-full border rounded px-3 py-2"
              rows="2"
            ></textarea>
          </div>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              id="cancelCategoryBtn"
              class="px-4 py-2 border rounded"
            >
              H·ªßy
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded"
            >
              T·∫°o
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  /**
   * Create Task Modal Handler - SIMPLIFIED & FIXED VERSION
   */
  console.log("üîß CREATE-TASK-MODAL: Script loaded");

  // Global variables
  let categoriesLoaded = false;

  // ============================================
  // 1. INITIALIZE MODAL
  // ============================================
  function initCreateTaskModal() {
    console.log("üîß CREATE-TASK-MODAL: Initializing...");

    // Check if user is logged in
    if (!Utils || !Utils.isLoggedIn()) {
      console.warn("‚ö†Ô∏è User not logged in, using default categories");
      renderCategories(getDefaultCategories());
      setupModalEvents();
      return;
    }

    // Setup event listeners
    setupModalEvents();

    // ‚úÖ LU√îN LOAD CATEGORIES M·ªñI KHI MODAL M·ªû
    loadCategories(true); // force reload = true

    console.log("‚úÖ CREATE-TASK-MODAL: Initialized");
  }

  // ============================================
  // 2. SETUP MODAL EVENTS
  // ============================================
  function setupModalEvents() {
    console.log("üîó Setting up modal events...");

    // Close modal buttons
    const closeBtn = document.getElementById("closeCreateTaskBtn");
    const cancelBtn = document.getElementById("cancelCreateTaskBtn");

    if (closeBtn) {
      closeBtn.addEventListener("click", closeModal);
    }

    if (cancelBtn) {
      cancelBtn.addEventListener("click", closeModal);
    }

    // Fixed time toggle
    const fixedTimeCheckbox = document.getElementById("taskFixedTime");
    const fixedTimeFields = document.getElementById("fixedTimeFields");

    if (fixedTimeCheckbox && fixedTimeFields) {
      fixedTimeCheckbox.addEventListener("change", function () {
        fixedTimeFields.classList.toggle("hidden", !this.checked);
      });
    }

    // Category modal
    const createCategoryBtn = document.getElementById("createNewCategoryBtn");
    const categoryModal = document.getElementById("createCategoryModal");

    if (createCategoryBtn && categoryModal) {
      createCategoryBtn.addEventListener("click", function (e) {
        e.preventDefault();
        categoryModal.classList.remove("hidden");
      });

      // Close category modal
      const closeCategoryBtn = document.getElementById("closeCategoryModalBtn");
      const cancelCategoryBtn = document.getElementById("cancelCategoryBtn");

      if (closeCategoryBtn)
        closeCategoryBtn.addEventListener("click", closeCategoryModal);
      if (cancelCategoryBtn)
        cancelCategoryBtn.addEventListener("click", closeCategoryModal);

      // Category form submit
      const categoryForm = document.getElementById("createCategoryForm");
      if (categoryForm) {
        categoryForm.addEventListener("submit", handleCreateCategory);
      }
    }

    // Task form submit
    const taskForm = document.getElementById("createTaskForm");
    if (taskForm) {
      taskForm.addEventListener("submit", handleCreateTask);
    }

    console.log("‚úÖ Modal events setup complete");
  }

  // ============================================
  // 3. LOAD CATEGORIES - SIMPLIFIED VERSION
  // ============================================
  async function loadCategories(forceReload = false) {
    const container = document.getElementById("category-container");
    if (!container) {
      console.error("‚ùå Category container not found");
      return;
    }

    // ‚úÖ B·ªé CHECK categoriesLoaded - LU√îN LOAD L·∫†I
    console.log("üì• Loading categories (force reload)...");

    // Show loading
    container.innerHTML = `
    <div class="text-center py-6">
      <i class="fas fa-spinner fa-spin text-blue-500 text-xl mb-2"></i>
      <p class="text-gray-500">ƒêang t·∫£i danh m·ª•c...</p>
    </div>
  `;

    try {
      let categories = [];

      // ‚úÖ S·ª¨ D·ª§NG ƒê√öNG ENDPOINT V√Ä METHOD
      if (window.Utils && typeof Utils.get === "function") {
        const response = await Utils.get("/api/categories");

        if (response.success && response.data) {
          categories = response.data;
          console.log(`‚úÖ Loaded ${categories.length} categories from server`);
        } else {
          console.warn("‚ö†Ô∏è Server returned no categories:", response.message);
        }
      } else if (window.Utils && typeof Utils.makeRequest === "function") {
        // Fallback: use makeRequest
        const response = await Utils.makeRequest("/api/categories", "GET");

        if (response.success && response.data) {
          categories = response.data;
          console.log(`‚úÖ Loaded ${categories.length} categories`);
        }
      } else {
        // Fallback cu·ªëi: fetch tr·ª±c ti·∫øp
        const token = localStorage.getItem("auth_token");
        if (token) {
          const response = await fetch("http://localhost:3000/api/categories", {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/json",
            },
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success && result.data) {
              categories = result.data;
            }
          }
        }
      }

      // N·∫øu kh√¥ng c√≥ categories, d√πng default
      if (!categories || categories.length === 0) {
        console.log("‚ÑπÔ∏è Using default categories");
        categories = getDefaultCategories();
      }

      // Render categories
      renderCategories(categories);
      categoriesLoaded = true;

      console.log(`‚úÖ Categories rendered: ${categories.length} items`);
    } catch (error) {
      console.error("‚ùå Error loading categories:", error);

      // Show error v·ªõi option ƒë·ªÉ th·ª≠ l·∫°i
      container.innerHTML = `
      <div class="text-center py-6">
        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-2"></i>
        <p class="text-red-600 mb-3">L·ªói t·∫£i danh m·ª•c</p>
        <button onclick="loadCategories(true)" 
                class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
          Th·ª≠ l·∫°i
        </button>
      </div>
    `;
    }
  }

  // ============================================
  // 4. RENDER CATEGORIES
  // ============================================
  function renderCategories(categories) {
    const container = document.getElementById("category-container");
    if (!container) return;

    if (!categories || categories.length === 0) {
      container.innerHTML = `
        <div class="text-center py-6 text-gray-500">
          <i class="fas fa-folder-open text-3xl mb-2 text-gray-300"></i>
          <p>Ch∆∞a c√≥ danh m·ª•c n√†o</p>
          <button id="createFirstCategoryBtn" 
                  class="mt-2 text-blue-600 hover:text-blue-800 text-sm">
            + T·∫°o danh m·ª•c ƒë·∫ßu ti√™n
          </button>
        </div>
      `;

      // Add event to create first category button
      setTimeout(() => {
        const btn = document.getElementById("createFirstCategoryBtn");
        if (btn) {
          btn.addEventListener("click", () => {
            document.getElementById("createNewCategoryBtn")?.click();
          });
        }
      }, 100);

      return;
    }

    let html = "";

    categories.forEach((cat, index) => {
      const id = cat.MaLoai || `cat_${index}`;
      const name = cat.TenLoai || "Kh√¥ng t√™n";
      const color = cat.MauSac || "#3B82F6";
      const isSelected = index === 0;

      html += `
        <div class="category-item ${isSelected ? "selected" : ""} 
                flex items-center gap-3 p-3 mb-2 border rounded-lg cursor-pointer 
                hover:bg-gray-50 transition-all"
             data-category-id="${id}"
             onclick="selectCategory(this)">
          
          <div class="w-4 h-4 rounded-full border-2 border-gray-300" 
               style="background-color: ${color}"></div>
          
          <span class="text-sm font-medium text-gray-700 flex-1">${name}</span>
          
          <input type="radio" 
                 name="taskCategory" 
                 value="${id}" 
                 ${isSelected ? "checked" : ""}
                 class="h-4 w-4 text-blue-600">
        </div>
      `;
    });

    container.innerHTML = html;
    console.log(`‚úÖ Rendered ${categories.length} categories`);
  }

  // ============================================
  // 5. HELPER FUNCTIONS
  // ============================================
  function getDefaultCategories() {
    return [
      { MaLoai: 1, TenLoai: "C√¥ng vi·ªác", MauSac: "#3B82F6", isDefault: true },
      { MaLoai: 2, TenLoai: "C√° nh√¢n", MauSac: "#10B981", isDefault: true },
      { MaLoai: 3, TenLoai: "H·ªçc t·∫≠p", MauSac: "#8B5CF6", isDefault: true },
      { MaLoai: 4, TenLoai: "Kh√°c", MauSac: "#6B7280", isDefault: true },
    ];
  }

  function showFallbackCategories() {
    console.log("üîÑ Showing fallback categories");
    const defaultCategories = getDefaultCategories();
    renderCategories(defaultCategories);
  }

  function selectCategory(element) {
    // Remove selection from all
    document.querySelectorAll(".category-item").forEach((item) => {
      item.classList.remove("selected", "border-blue-500", "bg-blue-50");
    });

    // Add selection to clicked
    element.classList.add("selected", "border-blue-500", "bg-blue-50");

    // Check the radio
    const radio = element.querySelector('input[type="radio"]');
    if (radio) radio.checked = true;
  }

  function getSelectedCategoryId() {
    const selected = document.querySelector(".category-item.selected");
    if (selected) {
      const radio = selected.querySelector('input[type="radio"]');
      return radio ? radio.value : null;
    }

    // Fallback: get first radio
    const firstRadio = document.querySelector('input[name="taskCategory"]');
    return firstRadio ? firstRadio.value : null;
  }

  function closeModal() {
    const modal = document.getElementById("createTaskModal");
    if (modal) {
      modal.style.display = "none";
      modal.classList.remove("active", "show");
    }

    // Reset form
    const form = document.getElementById("createTaskForm");
    if (form) form.reset();

    // Hide fixed time fields
    const fixedFields = document.getElementById("fixedTimeFields");
    if (fixedFields) fixedFields.classList.add("hidden");

    // Uncheck fixed time
    const fixedCheckbox = document.getElementById("taskFixedTime");
    if (fixedCheckbox) fixedCheckbox.checked = false;

    console.log("‚úÖ Modal closed");
  }

  function closeCategoryModal() {
    const modal = document.getElementById("createCategoryModal");
    if (modal) {
      modal.classList.add("hidden");
    }

    // Reset form
    const form = document.getElementById("createCategoryForm");
    if (form) form.reset();
  }

  // ============================================
  // 6. HANDLE FORM SUBMITS
  // ============================================
  async function handleCreateCategory(e) {
    e.preventDefault();

    const nameInput = document.getElementById("newCategoryName");
    const colorInput = document.getElementById("newCategoryColor");
    const descInput = document.getElementById("newCategoryDesc");

    if (!nameInput || !nameInput.value.trim()) {
      showToast("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c", "error");
      return;
    }

    const categoryData = {
      TenLoai: nameInput.value.trim(),
      MauSac: colorInput ? colorInput.value : "#3B82F6",
      MoTa: descInput ? descInput.value.trim() : "",
    };

    try {
      console.log("üì§ Creating category:", categoryData);

      // Use Utils if available
      let result;
      if (window.Utils && typeof Utils.post === "function") {
        result = await Utils.post("/api/categories", categoryData);
      } else {
        // Fallback with fetch
        const token = localStorage.getItem("auth_token");
        const response = await fetch("http://localhost:3000/api/categories", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(categoryData),
        });
        result = await response.json();
      }

      if (result.success) {
        showToast("T·∫°o danh m·ª•c th√†nh c√¥ng!", "success");
        closeCategoryModal();

        // Reload categories after delay
        setTimeout(() => loadCategories(), 500);
      } else {
        showToast(result.message || "L·ªói khi t·∫°o danh m·ª•c", "error");
      }
    } catch (error) {
      console.error("‚ùå Error creating category:", error);
      showToast("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");
    }
  }

  async function handleCreateTask(e) {
    e.preventDefault();

    console.log("üìù Submitting task form...");

    // Get selected category
    const categoryId = getSelectedCategoryId();
    if (!categoryId) {
      showToast("Vui l√≤ng ch·ªçn danh m·ª•c", "error");
      return;
    }

    // Gather form data
    const formData = {
      TieuDe: document.getElementById("taskTitle").value.trim(),
      MoTa: document.getElementById("taskDescription").value.trim(),
      MaLoai: categoryId,
      ThoiGianUocTinh:
        parseInt(document.getElementById("taskDuration").value) || 60,
      MucDoUuTien: parseInt(document.getElementById("taskPriority").value) || 2,
      MucDoPhucTap: document.getElementById("taskComplexity")?.value
        ? parseInt(document.getElementById("taskComplexity").value)
        : null,
      MucDoTapTrung: document.getElementById("taskFocusLevel")?.value
        ? parseInt(document.getElementById("taskFocusLevel").value)
        : null,
      ThoiDiemThichHop:
        document.getElementById("taskSuitableTime")?.value || null,
      LuongTheoGio:
        parseInt(document.getElementById("taskHourlyWage")?.value) || 0,
      CoThoiGianCoDinh:
        document.getElementById("taskFixedTime")?.checked || false,
    };

    // Validate required fields
    if (!formData.TieuDe) {
      showToast("Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ c√¥ng vi·ªác", "error");
      return;
    }

    // Handle fixed time if enabled
    if (formData.CoThoiGianCoDinh) {
      const startTime = document.getElementById("taskFixedStartTime")?.value;
      if (!startTime) {
        showToast("Vui l√≤ng ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu", "error");
        return;
      }
      formData.GioBatDauCoDinh = startTime;
      formData.LapLai =
        document.getElementById("taskRepeatOption")?.value || null;
    }

    try {
      console.log("üì§ Creating task:", formData);

      // Show loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
      submitBtn.disabled = true;

      // Create task using Utils
      const result = await Utils.post("/api/tasks", formData);

      // Restore button
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;

      if (result.success) {
        showToast("T·∫°o c√¥ng vi·ªác th√†nh c√¥ng!", "success");
        closeModal();

        // Reload tasks if WorkManager exists
        if (window.WorkManager && typeof WorkManager.loadTasks === "function") {
          setTimeout(() => WorkManager.loadTasks(), 500);
        }

        // Dispatch event for other components
        document.dispatchEvent(
          new CustomEvent("taskCreated", {
            detail: { task: result.data },
          })
        );
      } else {
        showToast(result.message || "L·ªói khi t·∫°o c√¥ng vi·ªác", "error");
      }
    } catch (error) {
      console.error("‚ùå Error creating task:", error);
      showToast("L·ªói k·∫øt n·ªëi m√°y ch·ªß", "error");

      // Restore button
      const submitBtn = e.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.innerHTML = "T·∫°o c√¥ng vi·ªác";
        submitBtn.disabled = false;
      }
    }
  }

  // ============================================
  // 7. TOAST FUNCTION (fallback)
  // ============================================
  function showToast(message, type = "info") {
    // Use Utils.showToast if available
    if (window.Utils && typeof Utils.showToast === "function") {
      Utils.showToast(message, type);
      return;
    }

    // Fallback toast
    const toast = document.createElement("div");
    toast.className = `fixed top-4 right-4 z-[9999] px-4 py-3 rounded-md shadow-lg ${
      type === "success"
        ? "bg-green-500"
        : type === "error"
        ? "bg-red-500"
        : "bg-blue-500"
    } text-white`;
    toast.innerHTML = `
      <div class="flex items-center gap-2">
        <i class="fas ${
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : "fa-info-circle"
        }"></i>
        <span>${message}</span>
      </div>
    `;

    document.body.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transition = "opacity 0.3s";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  const createTaskModal = document.getElementById("createTaskModal");
  if (createTaskModal) {
    // Method 1: MutationObserver ƒë·ªÉ detect khi modal hi·ªÉn th·ªã
    const modalObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "class"
        ) {
          const target = mutation.target;
          if (
            target.classList.contains("active") ||
            target.classList.contains("show")
          ) {
            console.log(
              "üîî Modal opened via class change, loading categories..."
            );
            setTimeout(() => loadCategories(true), 100);
          }
        }
      });
    });

    modalObserver.observe(createTaskModal, {
      attributes: true,
      attributeFilter: ["class", "style"],
    });

    // Method 2: Listen for style changes
    const styleObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "style"
        ) {
          const target = mutation.target;
          const display = window.getComputedStyle(target).display;
          if (display === "flex" || display === "block") {
            console.log(
              "üîî Modal opened via style change, loading categories..."
            );
            setTimeout(() => loadCategories(true), 100);
          }
        }
      });
    });

    styleObserver.observe(createTaskModal, {
      attributes: true,
      attributeFilter: ["style"],
    });
  }

  // Method 3: Listen for custom modal events
  window.addEventListener("modalOpened", function (e) {
    if (e.detail && e.detail.modalId === "createTaskModal") {
      console.log("Modal opened event received, loading categories...");
      setTimeout(() => {
        initCreateTaskModal();
        loadCategories(true);
      }, 50);
    }
  });

  // Method 4: Override ModalManager.showCreateTaskModal n·∫øu t·ªìn t·∫°i
  if (window.ModalManager && ModalManager.showCreateTaskModal) {
    const originalShowModal = ModalManager.showCreateTaskModal;

    ModalManager.showCreateTaskModal = function () {
      console.log(
        "üîî ModalManager.showCreateTaskModal called, loading categories..."
      );

      // Call original function
      originalShowModal.apply(this, arguments);

      // Load categories after modal opens
      setTimeout(() => {
        initCreateTaskModal();
        loadCategories(true);
      }, 150);
    };
  }

  // ============================================
  // 8. EXPOSE FUNCTIONS TO WINDOW
  // ============================================
  window.initCreateTaskModal = initCreateTaskModal;
  window.selectCategory = selectCategory;
  window.closeCreateTaskModal = closeModal;

  // ============================================
  // 9. AUTO-INIT WHEN MODAL OPENS
  // ============================================
  // Listen for modal opened event
  window.addEventListener("modalOpened", function (e) {
    if (e.detail && e.detail.modalId === "createTaskModal") {
      console.log("Modal opened, initializing...");
      setTimeout(() => initCreateTaskModal(), 50);
    }
  });

  // Also listen for direct clicks on modal open buttons
  document.addEventListener("click", function (e) {
    if (
      e.target.closest(
        '[data-target-modal="#createTaskModal"], [data-modal="createTaskModal"]'
      )
    ) {
      console.log("üñ±Ô∏è Direct modal open detected");
      setTimeout(() => initCreateTaskModal(), 100);
    }
  });

  console.log("‚úÖ CREATE-TASK-MODAL: Ready to initialize");

  window.debugCategories = function () {
    console.log("=== CATEGORY DEBUG ===");
    console.log(
      "Container exists:",
      !!document.getElementById("category-container")
    );
    console.log(
      "Modal visible:",
      document.getElementById("createTaskModal")?.style.display
    );
    console.log("Utils available:", typeof Utils !== "undefined");
    console.log(
      "Auth token:",
      localStorage.getItem("auth_token") ? "exists" : "missing"
    );

    // Test load
    console.log("\nüß™ Testing category load...");
    loadCategories(true);
  };

  console.log("‚úÖ Category loading functions updated");
  console.log("üí° Try: window.debugCategories() to test");
</script>
<style>
  .category-item input[type="radio"] {
    opacity: 0;
    position: absolute;
  }

  .category-item input[type="radio"]:checked + .flex {
    background-color: #eff6ff !important;
    border-color: #3b82f6 !important;
  }

  /* Highlight selected category */
  .category-item.selected {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
  }

  /* Hover effect */
  .category-item:hover {
    background-color: #f9fafb !important;
  }
  /* Fix modal display */
  #createTaskModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  #createTaskModal.active,
  #createTaskModal.show {
    display: flex !important;
  }

  #createTaskModal .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  }

  #createTaskModal .modal-content {
    position: relative;
    z-index: 10000;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  /* Category selection styles */
  .category-item.selected {
    border-color: #3b82f6 !important;
    background-color: #eff6ff !important;
  }

  .category-item:hover {
    background-color: #f9fafb !important;
  }

  /* Fixed time fields */
  #fixedTimeFields {
    transition: all 0.3s ease;
  }

  /* Ensure category container has proper scroll */
  #category-container {
    max-height: 200px;
    overflow-y: auto;
  }

  /* Remove spinner from loading text */
  .fa-spinner.fa-spin {
    animation: fa-spin 1s infinite linear;
  }
</style>
