<!-- AI Suggestion Modal - Complete Fixed Version -->
<div id="aiSuggestionModal" class="modal">
  <!-- Modal Overlay -->
  <div
    class="modal-overlay"
    onclick="ModalManager.hideModalById('aiSuggestionModal')"
  ></div>

  <!-- Modal Content -->
  <div class="modal-content ai-modal">
    <!-- Header -->
    <div class="ai-modal-header">
      <div class="modal-header-left">
        <div class="modal-icon">
          <i class="fas fa-robot"></i>
        </div>
        <div class="modal-title">
          <h3>T·∫°o L·ªãch Tr√¨nh Th√¥ng Minh</h3>
          <p class="modal-subtitle">AI s·∫Ω s·∫Øp x·∫øp c√¥ng vi·ªác t·ªëi ∆∞u cho b·∫°n</p>
        </div>
      </div>
      <button
        class="modal-close"
        onclick="ModalManager.hideModalById('aiSuggestionModal')"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Body -->
    <div class="ai-modal-body">
      <!-- Form v·ªõi ID ch√≠nh x√°c -->
      <form id="aiSuggestionForm">
        <!-- Date Range Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-calendar-alt"></i>
            <span>Ch·ªçn Kho·∫£ng Th·ªùi Gian</span>
          </div>
          <div class="date-range-grid">
            <div class="form-group">
              <label class="form-label">T·ª´ ng√†y</label>
              <input type="date" id="aiStartDate" class="date-input" required />
            </div>
            <div class="form-group">
              <label class="form-label">ƒê·∫øn ng√†y</label>
              <input type="date" id="aiEndDate" class="date-input" required />
            </div>
          </div>
        </div>

        <!-- Task Selection Section -->
        <div class="form-section">
          <div class="section-header">
            <div class="section-title">
              <i class="fas fa-tasks"></i>
              <span>Ch·ªçn C√¥ng Vi·ªác</span>
            </div>
            <button type="button" class="btn-select-all" id="selectAllTasksBtn">
              <i class="fas fa-check-double"></i>
              <span>Ch·ªçn t·∫•t c·∫£</span>
            </button>
          </div>

          <!-- Task List Container -->
          <div class="task-list-container">
            <div class="task-list" id="aiTaskList">
              <!-- Loading State -->
              <div class="loading-state">
                <div class="loading-spinner">
                  <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>ƒêang t·∫£i c√¥ng vi·ªác...</p>
              </div>
            </div>

            <!-- Task Stats -->
            <div class="task-stats" id="aiTaskStats">
              ƒê√£ ch·ªçn: <strong>0</strong> c√¥ng vi·ªác
            </div>
          </div>
        </div>

        <!-- AI Options Section -->
        <div class="form-section">
          <div class="section-title">
            <i class="fas fa-sliders-h"></i>
            <span>T√πy Ch·ªçn AI</span>
          </div>

          <div class="ai-options-grid">
            <!-- Option 1: Avoid Conflict -->
            <label class="ai-option">
              <input type="checkbox" id="aiOptionAvoidConflict" checked />
              <div class="option-content">
                <div class="option-icon">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <div class="option-text">
                  <strong>Tr√°nh tr√πng l·ªãch</strong>
                  <small>Kh√¥ng x·∫øp v√†o khung gi·ªù ƒë√£ c√≥</small>
                </div>
              </div>
            </label>

            <!-- Option 2: Consider Priority -->
            <label class="ai-option">
              <input type="checkbox" id="aiOptionConsiderPriority" checked />
              <div class="option-content">
                <div class="option-icon">
                  <i class="fas fa-star"></i>
                </div>
                <div class="option-text">
                  <strong>∆Øu ti√™n quan tr·ªçng</strong>
                  <small>X·∫øp vi·ªác quan tr·ªçng tr∆∞·ªõc</small>
                </div>
              </div>
            </label>

            <!-- Option 3: Balance Workload -->
            <label class="ai-option">
              <input type="checkbox" id="aiOptionBalanceWorkload" checked />
              <div class="option-content">
                <div class="option-icon">
                  <i class="fas fa-balance-scale"></i>
                </div>
                <div class="option-text">
                  <strong>C√¢n b·∫±ng kh·ªëi l∆∞·ª£ng</strong>
                  <small>Ph√¢n ƒë·ªÅu c√¥ng vi·ªác c√°c ng√†y</small>
                </div>
              </div>
            </label>
          </div>
        </div>
      </form>
    </div>

    <!-- Footer -->
    <div class="ai-modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        onclick="ModalManager.hideModalById('aiSuggestionModal')"
      >
        <i class="fas fa-times"></i>
        <span>ƒê√≥ng</span>
      </button>
      <button
        type="button"
        class="btn btn-primary"
        id="aiSubmitBtn"
        onclick="if (window.AIHandler && AIHandler.handleFormSubmitAction) { AIHandler.handleFormSubmitAction(); }"
      >
        <i class="fas fa-magic"></i>
        <span>T·∫°o L·ªãch Tr√¨nh</span>
      </button>
    </div>
  </div>
</div>

<script>
  console.log("ü§ñ AI Modal Script - Enhanced Integration v1.2");

  // Enhanced handler for modal initialization
  (function () {
    // Wait for AIHandler to be available
    function waitForAIHandler() {
      return new Promise((resolve) => {
        if (window.AIHandler) {
          console.log("‚úÖ AIHandler found");
          resolve(true);
        } else {
          console.log("‚è≥ Waiting for AIHandler...");
          setTimeout(() => waitForAIHandler().then(resolve), 100);
        }
      });
    }

    // Set default dates
    function setDefaultDates() {
      const today = new Date();
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 7);

      const startInput = document.getElementById("aiStartDate");
      const endInput = document.getElementById("aiEndDate");

      if (startInput) {
        startInput.value = today.toISOString().split("T")[0];
      }
      if (endInput) {
        endInput.value = endDate.toISOString().split("T")[0];
      }

      console.log("üìÖ Dates set:", startInput?.value, "to", endInput?.value);
    }

    // Initialize when modal is shown
    async function initializeAIModal() {
      console.log("üöÄ Initializing AI modal...");

      try {
        // Set dates
        setDefaultDates();

        // Wait for AIHandler
        await waitForAIHandler();

        // Call AIHandler to populate modal
        if (window.AIHandler && window.AIHandler.populateAIModal) {
          console.log("üìã Calling AIHandler.populateAIModal...");
          await AIHandler.populateAIModal();
          console.log("‚úÖ Modal populated");
        } else {
          console.error("‚ùå AIHandler.populateAIModal not available");
          showErrorInModal("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      } catch (error) {
        console.error("‚ùå Error initializing AI modal:", error);
        showErrorInModal(error.message);
      }
    }

    // Show error in modal
    function showErrorInModal(message) {
      const modalBody = document.querySelector(
        "#aiSuggestionModal .ai-modal-body"
      );
      if (modalBody) {
        modalBody.innerHTML = `
          <div class="error-state" style="text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #EF4444; margin-bottom: 20px;"></i>
            <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p>
            <p style="color: #666; margin-bottom: 20px;">${
              message || "ƒê√£ x·∫£y ra l·ªói"
            }</p>
            <button class="btn btn-primary" onclick="initializeAIModal()" style="padding: 10px 20px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer;">
              <i class="fas fa-redo"></i>
              Th·ª≠ l·∫°i
            </button>
          </div>
        `;
      }
    }

    // Listen for modal show events
    document.addEventListener("modal-shown", (e) => {
      if (e.detail && e.detail.modalId === "aiSuggestionModal") {
        console.log("üéØ AI Modal shown, initializing...");
        setTimeout(initializeAIModal, 300);
      }
    });

    // Also listen for manual modal open
    const modal = document.getElementById("aiSuggestionModal");
    if (modal) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (
            mutation.type === "attributes" &&
            mutation.attributeName === "class" &&
            (modal.classList.contains("active") ||
              modal.classList.contains("show")) &&
            !modal.dataset.initialized
          ) {
            console.log("üëÅÔ∏è Modal became visible, initializing...");
            modal.dataset.initialized = "true";
            setTimeout(initializeAIModal, 300);
          }
        });
      });

      observer.observe(modal, { attributes: true });
    }

    // Expose function for manual initialization
    window.initializeAIModal = initializeAIModal;

    console.log("‚úÖ AI Modal Script ready");
  })();
</script>
